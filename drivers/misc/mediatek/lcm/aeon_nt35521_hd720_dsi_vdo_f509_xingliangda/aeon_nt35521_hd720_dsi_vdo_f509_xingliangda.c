#ifndef BUILD_LK
#include <linux/string.h>
#endif
#include "lcm_drv.h"

#ifdef BUILD_LK
	#include <platform/mt_gpio.h>
#elif defined(BUILD_UBOOT)
    #include <asm/arch/mt_gpio.h>
#else
    #include <mt-plat/mt_gpio.h>
    #include <linux/gpio.h>	
#endif
// ---------------------------------------------------------------------------
//  Local Constants
// ---------------------------------------------------------------------------

#define FRAME_WIDTH  										(720)
#define FRAME_HEIGHT 										(1280)
#define REGFLAG_DELAY             							0xFFE
#define REGFLAG_END_OF_TABLE      							0xFFF   // END OF REGISTERS MARKER

#define LCM_DSI_CMD_MODE									0
// ---------------------------------------------------------------------------
//  Local Variables
// ---------------------------------------------------------------------------

static LCM_UTIL_FUNCS lcm_util = {0};

#define SET_RESET_PIN(v)    								(lcm_util.set_reset_pin((v)))

#define UDELAY(n) 											(lcm_util.udelay(n))
#define MDELAY(n) 											(lcm_util.mdelay(n))


// ---------------------------------------------------------------------------
//  Local Functions
// ---------------------------------------------------------------------------

#define dsi_set_cmdq_V2(cmd, count, ppara, force_update)	lcm_util.dsi_set_cmdq_V2(cmd, count, ppara, force_update)
#define dsi_set_cmdq(pdata, queue_size, force_update)		lcm_util.dsi_set_cmdq(pdata, queue_size, force_update)
#define wrtie_cmd(cmd)										lcm_util.dsi_write_cmd(cmd)
#define write_regs(addr, pdata, byte_nums)					lcm_util.dsi_write_regs(addr, pdata, byte_nums)
#define read_reg											lcm_util.dsi_read_reg()
#define read_reg_v2(cmd, buffer, buffer_size)   			lcm_util.dsi_dcs_read_lcm_reg_v2(cmd, buffer, buffer_size)    

extern unsigned int opium_gpio_get(const char *name);

struct LCM_setting_table {
    unsigned cmd;
    unsigned char count;
    unsigned char para_list[128];
};

static struct LCM_setting_table lcm_initialization_setting[] = {
    { 0xff, 0x04, {0xaa, 0x55, 0x25, 0x01}},
    { 0x6f, 0x01, {0x03}},
    { 0xf4, 0x01, {0x60}},
    { 0x6f, 0x01, {0x06}},
    { 0xf4, 0x01, {0x01}},
    { 0x6f, 0x01, {0x21}},
    { 0xf7, 0x01, {0x01}},
    { 0x6f, 0x01, {0x21}},
    { 0xf7, 0x01, {0x00}},
    { 0xfc, 0x01, {0x08}},
    { 0xfc, 0x01, {0x00}},
    { 0xff, 0x04, {0xaa, 0x55, 0x25, 0x00}},
    { 0xff, 0x04, {0xaa, 0x55, 0xa5, 0x80}},
    { 0x6f, 0x02, {0x11, 0x00}},
    { 0xf7, 0x02, {0x20, 0x00}},
    { 0x6f, 0x01, {0x06}},
    { 0xf7, 0x01, {0xa0}},
    { 0x6f, 0x01, {0x19}},
    { 0xf7, 0x01, {0x12}},
    { 0x6f, 0x01, {0x02}},
    { 0xf7, 0x01, {0x47}},
    { 0x6f, 0x01, {0x17}},
    { 0xf4, 0x01, {0x70}},
    { 0x6f, 0x01, {0x01}},
    { 0xf9, 0x01, {0x46}},
    { 0xf0, 0x05, {0x55, 0xaa, 0x52, 0x08, 0x00}},
    { 0xbd, 0x05, {0x01, 0xa0, 0x10, 0x10, 0x01}},
    { 0xb8, 0x04, {0x00, 0x00, 0x00, 0x00}},
    { 0xbb, 0x02, {0x24, 0x24}},
    { 0xbc, 0x02, {0x00, 0x00}},
    { 0xb6, 0x01, {0x04}},
    { 0xc8, 0x01, {0x80}},
    { 0xd9, 0x02, {0x01, 0x01}},
    { 0xd4, 0x01, {0xc7}},
    { 0xb1, 0x02, {0x68, 0x21}},
    { 0xf0, 0x05, {0x55, 0xaa, 0x52, 0x08, 0x01}},
    { 0xb0, 0x02, {0x09, 0x09}},
    { 0xb1, 0x02, {0x09, 0x09}},
    { 0xbc, 0x02, {0xa0, 0x00}},
    { 0xbd, 0x02, {0xa0, 0x00}},
    { 0xbe, 0x01, {0x40}},
    { 0xca, 0x01, {0x00}},
    { 0xc0, 0x01, {0x0c}},
    { 0xb5, 0x02, {0x03, 0x03}},
    { 0xb3, 0x02, {0x0d, 0x0d}},
    { 0xb4, 0x02, {0x19, 0x19}},
    { 0xb9, 0x02, {0x26, 0x26}},
    { 0xba, 0x02, {0x14, 0x14}},
    { 0xf0, 0x05, {0x55, 0xaa, 0x52, 0x08, 0x02}},
    { 0xb0, 0x10, {0x00, 0x01, 0x00, 0x02, 0x00, 0x20, 0x00, 0x46, 0x00, 0x62, 0x00, 0x86, 0x00, 0xa3, 0x00, 0xd5}},
    { 0xb1, 0x10, {0x00, 0xf8, 0x01, 0x30, 0x01, 0x5e, 0x01, 0xa6, 0x01, 0xdd, 0x01, 0xde, 0x02, 0x11, 0x02, 0x4d}},
    { 0xb2, 0x10, {0x02, 0x74, 0x02, 0xa8, 0x02, 0xca, 0x02, 0xfc, 0x03, 0x19, 0x03, 0x3a, 0x03, 0x72, 0x03, 0x73}},
    { 0xb3, 0x04, {0x03, 0x78, 0x03, 0x79}},
    { 0xb4, 0x10, {0x00, 0x19, 0x00, 0x30, 0x00, 0x4f, 0x00, 0x65, 0x00, 0x78, 0x00, 0x98, 0x00, 0xb3, 0x00, 0xdc}},
    { 0xb5, 0x10, {0x00, 0xfe, 0x01, 0x36, 0x01, 0x61, 0x01, 0xa6, 0x01, 0xde, 0x01, 0xe0, 0x02, 0x14, 0x02, 0x4e}},
    { 0xb6, 0x10, {0x02, 0x75, 0x02, 0xa8, 0x02, 0xcc, 0x02, 0xfc, 0x03, 0x19, 0x03, 0x34, 0x03, 0x6e, 0x03, 0x6f}},
    { 0xb7, 0x04, {0x03, 0x83, 0x03, 0x85}},
    { 0xb8, 0x10, {0x00, 0x44, 0x00, 0x51, 0x00, 0x65, 0x00, 0x77, 0x00, 0x85, 0x00, 0xa0, 0x00, 0xb8, 0x00, 0xdf}},
    { 0xb9, 0x10, {0x00, 0xff, 0x01, 0x35, 0x01, 0x60, 0x01, 0xa6, 0x01, 0xdd, 0x01, 0xdf, 0x02, 0x14, 0x02, 0x4f}},
    { 0xba, 0x10, {0x02, 0x77, 0x02, 0xad, 0x02, 0xd5, 0x03, 0x0f, 0x03, 0x3e, 0x03, 0xb6, 0x03, 0xca, 0x03, 0xec}},
    { 0xbb, 0x04, {0x03, 0xf4, 0x03, 0xfc}},
    { 0xbc, 0x10, {0x00, 0x01, 0x00, 0x02, 0x00, 0x20, 0x00, 0x46, 0x00, 0x62, 0x00, 0x86, 0x00, 0xa3, 0x00, 0xd5}},
    { 0xbd, 0x10, {0x00, 0xf8, 0x01, 0x30, 0x01, 0x5e, 0x01, 0xa6, 0x01, 0xdd, 0x01, 0xde, 0x02, 0x11, 0x02, 0x4d}},
    { 0xbe, 0x10, {0x02, 0x74, 0x02, 0xa8, 0x02, 0xca, 0x02, 0xfc, 0x03, 0x19, 0x03, 0x3a, 0x03, 0x72, 0x03, 0x73}},
    { 0xbf, 0x04, {0x03, 0x78, 0x03, 0x79}},
    { 0xc0, 0x10, {0x00, 0x19, 0x00, 0x30, 0x00, 0x4f, 0x00, 0x65, 0x00, 0x78, 0x00, 0x98, 0x00, 0xb3, 0x00, 0xdc}},
    { 0xc1, 0x10, {0x00, 0xfe, 0x01, 0x36, 0x01, 0x61, 0x01, 0xa6, 0x01, 0xde, 0x01, 0xe0, 0x02, 0x14, 0x02, 0x4e}},
    { 0xc2, 0x10, {0x02, 0x75, 0x02, 0xa8, 0x02, 0xcc, 0x02, 0xfc, 0x03, 0x19, 0x03, 0x34, 0x03, 0x6e, 0x03, 0x6f}},
    { 0xc3, 0x04, {0x03, 0x83, 0x03, 0x85}},
    { 0xc4, 0x10, {0x00, 0x44, 0x00, 0x51, 0x00, 0x65, 0x00, 0x77, 0x00, 0x85, 0x00, 0xa0, 0x00, 0xb8, 0x00, 0xdf}},
    { 0xc5, 0x10, {0x00, 0xff, 0x01, 0x35, 0x01, 0x60, 0x01, 0xa6, 0x01, 0xdd, 0x01, 0xdf, 0x02, 0x14, 0x02, 0x4f}},
    { 0xc6, 0x10, {0x02, 0x77, 0x02, 0xad, 0x02, 0xd5, 0x03, 0x0f, 0x03, 0x3e, 0x03, 0xb6, 0x03, 0xca, 0x03, 0xec}},
    { 0xc7, 0x04, {0x03, 0xf4, 0x03, 0xfc}},
    { 0xf0, 0x05, {0x55, 0xaa, 0x52, 0x08, 0x06}},
    { 0xb0, 0x02, {0x31, 0x2e}},
    { 0xb1, 0x02, {0x10, 0x12}},
    { 0xb2, 0x02, {0x16, 0x18}},
    { 0xb3, 0x02, {0x31, 0x31}},
    { 0xb4, 0x02, {0x31, 0x34}},
    { 0xb5, 0x02, {0x34, 0x34}},
    { 0xb6, 0x02, {0x34, 0x34}},
    { 0xb7, 0x02, {0x34, 0x34}},
    { 0xb8, 0x02, {0x33, 0x2d}},
    { 0xb9, 0x02, {0x00, 0x02}},
    { 0xba, 0x02, {0x03, 0x01}},
    { 0xbb, 0x02, {0x2d, 0x33}},
    { 0xbc, 0x02, {0x34, 0x34}},
    { 0xbd, 0x02, {0x34, 0x34}},
    { 0xbe, 0x02, {0x34, 0x34}},
    { 0xbf, 0x02, {0x34, 0x31}},
    { 0xc0, 0x02, {0x31, 0x31}},
    { 0xc1, 0x02, {0x19, 0x17}},
    { 0xc2, 0x02, {0x13, 0x11}},
    { 0xc3, 0x02, {0x2e, 0x31}},
    { 0xe5, 0x02, {0x31, 0x31}},
    { 0xc4, 0x02, {0x31, 0x2d}},
    { 0xc5, 0x02, {0x19, 0x17}},
    { 0xc6, 0x02, {0x13, 0x11}},
    { 0xc7, 0x02, {0x31, 0x31}},
    { 0xc8, 0x02, {0x31, 0x34}},
    { 0xc9, 0x02, {0x34, 0x34}},
    { 0xca, 0x02, {0x34, 0x34}},
    { 0xcb, 0x02, {0x34, 0x34}},
    { 0xcc, 0x02, {0x33, 0x2e}},
    { 0xcd, 0x02, {0x03, 0x01}},
    { 0xce, 0x02, {0x00, 0x02}},
    { 0xcf, 0x02, {0x2e, 0x33}},
    { 0xd0, 0x02, {0x34, 0x34}},
    { 0xd1, 0x02, {0x34, 0x34}},
    { 0xd2, 0x02, {0x34, 0x34}},
    { 0xd3, 0x02, {0x34, 0x31}},
    { 0xd4, 0x02, {0x31, 0x31}},
    { 0xd5, 0x02, {0x10, 0x12}},
    { 0xd6, 0x02, {0x16, 0x18}},
    { 0xd7, 0x02, {0x2d, 0x31}},
    { 0xe6, 0x02, {0x31, 0x31}},
    { 0xd8, 0x05, {0x00, 0x00, 0x00, 0x00, 0x00}},
    { 0xd9, 0x05, {0x00, 0x00, 0x00, 0x00, 0x00}},
    { 0xe7, 0x01, {0x00}},
    { 0xf0, 0x05, {0x55, 0xaa, 0x52, 0x08, 0x05}},
    { 0xed, 0x01, {0x30}},
    { 0xb0, 0x02, {0x17, 0x06}},
    { 0xb8, 0x01, {0x00}},
    { 0xc0, 0x01, {0x0d}},
    { 0xc1, 0x01, {0x0b}},
    { 0xc2, 0x01, {0x00}},
    { 0xc3, 0x01, {0x00}},
    { 0xc4, 0x01, {0x84}},
    { 0xc5, 0x01, {0x82}},
    { 0xc6, 0x01, {0x82}},
    { 0xc7, 0x01, {0x80}},
    { 0xc8, 0x02, {0x0b, 0x20}},
    { 0xc9, 0x02, {0x07, 0x20}},
    { 0xca, 0x02, {0x01, 0x10}},
    { 0xd1, 0x05, {0x03, 0x05, 0x05, 0x07, 0x00}},
    { 0xd2, 0x05, {0x03, 0x05, 0x09, 0x03, 0x00}},
    { 0xd3, 0x05, {0x00, 0x00, 0x6a, 0x07, 0x10}},
    { 0xd4, 0x05, {0x30, 0x00, 0x6a, 0x07, 0x10}},
    { 0xf0, 0x05, {0x55, 0xaa, 0x52, 0x08, 0x03}},
    { 0xb0, 0x02, {0x00, 0x00}},
    { 0xb1, 0x02, {0x00, 0x00}},
    { 0xb2, 0x05, {0x05, 0x01, 0x13, 0x00, 0x00}},
    { 0xb3, 0x05, {0x05, 0x01, 0x13, 0x00, 0x00}},
    { 0xb4, 0x05, {0x05, 0x01, 0x13, 0x00, 0x00}},
    { 0xb5, 0x05, {0x05, 0x01, 0x13, 0x00, 0x00}},
    { 0xb6, 0x05, {0x02, 0x01, 0x13, 0x00, 0x00}},
    { 0xb7, 0x05, {0x02, 0x01, 0x13, 0x00, 0x00}},
    { 0xb8, 0x05, {0x02, 0x01, 0x13, 0x00, 0x00}},
    { 0xb9, 0x05, {0x02, 0x01, 0x13, 0x00, 0x00}},
    { 0xba, 0x05, {0x53, 0x01, 0x13, 0x00, 0x00}},
    { 0xbb, 0x05, {0x53, 0x01, 0x13, 0x00, 0x00}},
    { 0xbc, 0x05, {0x53, 0x01, 0x13, 0x00, 0x00}},
    { 0xbd, 0x05, {0x53, 0x01, 0x13, 0x00, 0x00}},
    { 0xc4, 0x01, {0x60}},
    { 0xc5, 0x01, {0x40}},
    { 0xc6, 0x01, {0x64}},
    { 0xc7, 0x01, {0x44}},
    { 0x6f, 0x01, {0x11}},
    { 0xf3, 0x01, {0x01}},
    { 0x35, 0x01, {0x00}},
    { 0xff, 0x04, {0xaa, 0x55, 0x25, 0x01}},
    { 0x6f, 0x01, {0x1c}},
    { 0xfa, 0x01, {0x01}},
    { 0xff, 0x04, {0xaa, 0x55, 0x25, 0x00}},
    { 0xf0, 0x05, {0x55, 0xaa, 0x52, 0x08, 0x04}},
    { 0xea, 0x04, {0x00, 0x00, 0x3f, 0x7f}},
    { 0x11, 0x01, {0x00}},
    { REGFLAG_DELAY, 150, {}},
    { 0x29, 0x01, {0x00}},
    { REGFLAG_DELAY, 50, {}},
};


static void push_table(struct LCM_setting_table *table, unsigned int count, unsigned char force_update)
{
	unsigned int i;

    for(i = 0; i < count; i++) {
		
        unsigned cmd;
        cmd = table[i].cmd;
		
        switch (cmd) {
			
            case REGFLAG_DELAY :
                MDELAY(table[i].count);
                break;
				
            case REGFLAG_END_OF_TABLE :
                break;
				
            default:
				dsi_set_cmdq_V2(cmd, table[i].count, table[i].para_list, force_update);
       	}
    }
	
}

// ---------------------------------------------------------------------------
//  LCM Driver Implementations
// ---------------------------------------------------------------------------

static void lcm_set_util_funcs(const LCM_UTIL_FUNCS *util)
{
    memcpy(&lcm_util, util, sizeof(LCM_UTIL_FUNCS));
}

static void lcm_get_params(LCM_PARAMS *params)
{
    memset(params, 0, sizeof(LCM_PARAMS));
    params->dsi.mode = 3;
    params->dsi.LANE_NUM = 4;
    params->dsi.packet_size = 256;
    params->dsi.vertical_backporch = 16;
    params->dsi.vertical_frontporch = 20;
    params->dsi.horizontal_sync_active = 8;
    params->dsi.PLL_CLOCK = 240;
    params->dsi.lcm_esd_check_table[0].cmd = 10;
    params->dsi.lcm_esd_check_table[0].para_list[0] = 0x9Cu;
    params->type = 2;
    params->dsi.data_format.format = 2;
    params->dsi.PS = 2;
    params->dsi.vertical_sync_active = 2;
    params->dsi.ssc_range = 2;
    params->dsi.noncont_clock_period = 2;
    params->width = 720;
    params->dsi.horizontal_active_pixel = 720;
    params->height = 1280;
    params->dsi.vertical_active_line = 1280;
    params->dbi.te_mode = 1;
    params->dsi.esd_check_enable = 1;
    params->dsi.customization_esd_check_enable = 1;
    params->dsi.lcm_esd_check_table[0].count = 1;
    params->dsi.noncont_clock = 1;
    params->dbi.te_edge_polarity = 0;
    params->dsi.data_format.color_order = 0;
    params->dsi.data_format.trans_seq = 0;
    params->dsi.data_format.padding = 0;
    params->dsi.ssc_disable = 0;
    params->dsi.horizontal_backporch = 160;
    params->dsi.horizontal_frontporch = 160;
}


static void lcm_init(void)
{
    SET_RESET_PIN(1);
    MDELAY(20);
    SET_RESET_PIN(0);
    MDELAY(20);
    SET_RESET_PIN(1);
    MDELAY(120);
    push_table(lcm_initialization_setting, sizeof(lcm_initialization_setting) / sizeof(struct LCM_setting_table), 1);  
}

static void lcm_suspend(void)
{
    unsigned int array[16];  
    array[0] = 0x280500;
    dsi_set_cmdq(array, 1, 1);
    array[0] = 0x100500;
    dsi_set_cmdq(array, 1, 1);
    SET_RESET_PIN(1);
    SET_RESET_PIN(0);
    MDELAY(1);
    SET_RESET_PIN(1);
    MDELAY(120);
}

static void lcm_resume(void)
{
    lcm_init();
    
}

static unsigned int lcm_compare_id(void)
{
    unsigned int array[16];
    unsigned char buffer[3];
    unsigned int id;
    
    SET_RESET_PIN(1);
    MDELAY(10);
    SET_RESET_PIN(0);
    MDELAY(20);
    SET_RESET_PIN(1);
    MDELAY(80);
    array[0] = 0x63902;
    array[1] = 0x52AA55F0;
    array[2] = 0x108;
    dsi_set_cmdq(array, 3, 1);
    MDELAY(10);
    array[0] = 0x33700;
    dsi_set_cmdq(array, 1, 1);
    MDELAY(10);
    read_reg_v2(0xC5, buffer, 3);
    
    id = buffer[1] | (buffer[0] << 8);
    
//    LCD_DEBUG("lcm_compare_id nt35521 buffer[0] = 0x%x,buffer[1] = 0x%x,buffer[2] = 0x%x\n", buffer[0], buffer[1], buffer[2]);
    
    return (0x5521 == id)?1:0;
    
}

LCM_DRIVER aeon_nt35521_hd720_dsi_vdo_f509_xingliangda_lcm_drv =
{
    .name           	= "aeon_nt35521_hd720_dsi_vdo_f509_xingliangda",
    .set_util_funcs 	= lcm_set_util_funcs,
    .get_params     	= lcm_get_params,
    .init           	= lcm_init,
    .suspend        	= lcm_suspend,
    .resume         	= lcm_resume,
    .compare_id     	= lcm_compare_id,
};
